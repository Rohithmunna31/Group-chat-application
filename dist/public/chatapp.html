<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>
    <title>Group chat application</title>
    <!-- <link rel="stylesheet" href="chatapp.css" /> -->
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        text-align: center;
      }

      footer {
        background-color: #333;
        color: #fff;
        padding: 20px;
        position: fixed;
        bottom: 0;
        width: 100%;
        display: flex;
        justify-content: center;
      }

      form {
        display: flex;
        align-items: center;
      }

      input[type="text"] {
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 400px;
        margin-right: 10px;
      }

      button {
        background-color: #007bff;
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
      }

      input[type="submit"]:hover {
        background-color: #0056b3;
      }

      h1 {
        text-align: center;
      }
      #displaymessages {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #f9f9f9;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #displaymessages p {
        margin: 5px 0;
        padding: 8px;
        background-color: #e9a14e;
        color: #fff;
        border-radius: 5px;
      }
      aside button {
        position: fixed;
        color: #e8edf3;
        top: 0rem;
        right: 2rem;
      }
    </style>
  </head>
  <body>
    <h1>Group Chat app</h1>

    <p>You joined</p>
    <div id="displaymessages"></div>

    <aside>
      <button id="invitelink">Invite Link</button>

      <div id="invitationlink"></div>

      <!-- <button id="hideinvite">Hide invite link</button> -->
    </aside>

    <footer>
      <form>
        <input type="text" placeholder="Enter your message" id="inputmessage" />
        <button id="sendmessage">Send</button>
      </form>
    </footer>

    <script>
      const urls = window.location.href.split("/");
      const groupid = urls[urls.length - 1];

      const token = localStorage.getItem("token");
      let messageid = 0;
      let localMessages = null;
      localStorage.setItem("localMessages", localMessages);

      const fetchAndDisplayMessages = () => {
        axios
          .post(`http://localhost:3000/group/chats/${messageid}${groupid}`, {
            Authorization: token,
          })
          .then((res) => {
            console.log("in fetch and display functions");
            let localMessages = localStorage.getItem("localMessages");
            localMessages = JSON.parse(localMessages);
            console.log(res.data);
            const allMessages = res.data.allMessages;
            document.getElementById("displaymessages").innerHTML = "";

            if (localMessages) {
              for (let i = 0; i < localMessages.length; i++) {
                document.getElementById(
                  "displaymessages"
                ).innerHTML += `<p> ${localMessages[i].User.username} : ${localMessages[i].message} </p>`;
                console.log("in local storage messages");
              }
            }

            if (allMessages) {
              for (let i = 0; i < allMessages.length; i++) {
                document.getElementById(
                  "displaymessages"
                ).innerHTML += `<p> ${allMessages[i].User.username} : ${allMessages[i].message} </p>`;
                console.log("in backend messages");
              }
            }

            if (
              localMessages &&
              localMessages.concat(allMessages).length <= 1000
            ) {
              localStorage.setItem(
                "localMessages",
                JSON.stringify(localMessages.concat(allMessages))
              );
            }

            console.log(localStorage.getItem("localMessages"));
            let Messages = localStorage.getItem("localMessages");
            Messages = JSON.parse(Messages);

            if (Messages) {
              messageid = Messages.length;
              console.log("messageid", messageid);
            }
          });
      };
      // setInterval(fetchAndDisplayMessages, 1000);
      fetchAndDisplayMessages();

      document.getElementById("sendmessage").addEventListener("click", (e) => {
        e.preventDefault();

        const message = document.getElementById("inputmessage").value;
        const token = localStorage.getItem("token");

        axios
          .post(`/group/chat/${groupid}`, {
            message,
            Authorization: token,
          })
          .then((res) => {
            document.getElementById(
              "displaymessages"
            ).innerHTML += `<p> you : ${res.data.message} <p/>`;
            console.log(res);
          })
          .catch((err) => {
            console.log(err);
          });
      });

      document.getElementById("invitelink").addEventListener("click", (e) => {
        const invitationlink = document.getElementById("invitationlink");

        console.log("am i coming here invite link");

        invitationlink.innerHTML = ` http://localhost:3000/group/joingroup/${groupid}`;

        invitationlink.style.position = "fixed";

        invitationlink.style.top = "5rem";
        invitationlink.style.right = "2rem";
      });

      // document
      //   .getElementById("hideinvitelink")
      //   .addEventListener("click", (e) => {
      //     const invitationlink = document.getElementById("invitationlink");

      //     invitationlink.style.visibility = "hidden";
      //   });
    </script>
  </body>
</html>
